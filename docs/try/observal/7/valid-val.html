<meta charset="utf-8">
<!--
<script src="../js/util/test.js"></script>
<script src="../lib/underscore/1.13.6/min.js"></script>
<script src="../js/util/type.js"></script>
-->
<script src="../../../js/util/test.js"></script>
<script src="../../../lib/underscore/1.13.6/min.js"></script>
<script src="../../../js/util/type.js"></script>
<!--<script src="../js/util/syntax-sugar/observal.js"></script>-->
<script src="set-val.js"></script>
<script>
window.addEventListener('DOMContentLoaded', (event) => {
    const test = new Test()
    test.run([
        ()=>{
            const v = new ValidVal()
            if (undefined!==v.v) { return false }
            if (undefined!==v._v) { return false }
            let o = v.v
            if (undefined!==o) { return false }
            for (let id of 'Begin,Validate,Set,SetDefault,Valid,Invalid,Changed,End'.split(',')) {
                if (v[`_on${id}`]!==_Val.defaultMethods[`on${id}`]) { return false }
                if (!v[`_isFnOn${id}`]) { return false } // デフォルト関数がセットされているので真を返すはず
            }
            if (v._runOnBegin(0)!==undefined) { return false } // 何もしない
            if (v._runOnValidate(0)!==true) { return false }   // 必ず真を返す
            if (v._runOnSet(0)!==0) { return false }           // 入力値をそのまま返す
            if (v._runOnSetDefault(0)!==o) { return false }    // 前回値をそのまま返す
            if (v._runOnValid(0,undefined)!==undefined) { return false }   // 何もしない
            if (v._runOnInvalid(0,undefined)!==undefined) { return false } // 何もしない
            if (v._runOnValid(0,undefined)!==undefined) { return false }   // 何もしない
            if (v._runOnChanged(0,undefined)!==undefined) { return false } // 何もしない
            if (v._runOnEnd(0,undefined)!==undefined) { return false }     // 何もしない
            return true
        },
        ()=>{
            const v = new ValidVal(0)
            if (0!==v.v) { return false }
            if (0!==v._v) { return false }
            let o = v.v
            if (0!==o) { return false }
            for (let id of 'Begin,Validate,Set,SetDefault,Valid,Invalid,Changed,End'.split(',')) {
                if (v[`_on${id}`]!==_Val.defaultMethods[`on${id}`]) { return false }
                if (!v[`_isFnOn${id}`]) { return false } // デフォルト関数がセットされているので真を返すはず
            }
            if (v._runOnBegin(1)!==undefined) { return false } // 何もしない
            if (v._runOnValidate(1)!==true) { return false }   // 必ず真を返す
            if (v._runOnSet(1)!==1) { return false }           // 入力値をそのまま返す
            if (v._runOnSetDefault(1)!==o) { return false }    // 前回値をそのまま返す
            if (v._runOnValid(1,0)!==undefined) { return false }   // 何もしない
            if (v._runOnInvalid(1,0)!==undefined) { return false } // 何もしない
            if (v._runOnValid(1,0)!==undefined) { return false }   // 何もしない
            if (v._runOnChanged(1,0)!==undefined) { return false } // 何もしない
            if (v._runOnEnd(1,0)!==undefined) { return false }     // 何もしない
            return true
        },
        ()=>{
            let i = 'A'
            const v = new ValidVal(i)
            if (i!==v.v) { return false }
            if (i!==v._v) { return false }
            let o = v.v
            if (i!==o) { return false }
            for (let id of 'Begin,Validate,Set,SetDefault,Valid,Invalid,Changed,End'.split(',')) {
                if (v[`_on${id}`]!==_Val.defaultMethods[`on${id}`]) { return false }
                if (!v[`_isFnOn${id}`]) { return false } // デフォルト関数がセットされているので真を返すはず
            }
            i = 'B'
            if (v._runOnBegin(i)!==undefined) { return false } // 何もしない
            if (v._runOnValidate(i)!==true) { return false }   // 必ず真を返す
            if (v._runOnSet(i)!==i) { return false }           // 入力値をそのまま返す
            if (v._runOnSetDefault(i)!==o) { return false }    // 前回値をそのまま返す
            if (v._runOnValid(i,o)!==undefined) { return false }   // 何もしない
            if (v._runOnInvalid(i,o)!==undefined) { return false } // 何もしない
            if (v._runOnValid(i,o)!==undefined) { return false }   // 何もしない
            if (v._runOnChanged(i,o)!==undefined) { return false } // 何もしない
            if (v._runOnEnd(i,o)!==undefined) { return false }     // 何もしない
            return true
        },
        ()=>{
            let i = ['A']
            const v = new ValidVal(i)
            if (i!==v.v) { return false }
            if (i!==v._v) { return false }
            let o = v.v
            if (i!==o) { return false }
            for (let id of 'Begin,Validate,Set,SetDefault,Valid,Invalid,Changed,End'.split(',')) {
                if (v[`_on${id}`]!==_Val.defaultMethods[`on${id}`]) { return false }
                if (!v[`_isFnOn${id}`]) { return false } // デフォルト関数がセットされているので真を返すはず
            }
            i = ['B']
            if (v._runOnBegin(i)!==undefined) { return false } // 何もしない
            if (v._runOnValidate(i)!==true) { return false }   // 必ず真を返す
            if (v._runOnSet(i)!==i) { return false }           // 入力値をそのまま返す
            if (v._runOnSetDefault(i)!==o) { return false }    // 前回値をそのまま返す
            if (v._runOnValid(i,o)!==undefined) { return false }   // 何もしない
            if (v._runOnInvalid(i,o)!==undefined) { return false } // 何もしない
            if (v._runOnValid(i,o)!==undefined) { return false }   // 何もしない
            if (v._runOnChanged(i,o)!==undefined) { return false } // 何もしない
            if (v._runOnEnd(i,o)!==undefined) { return false }     // 何もしない
            return true
        },
        ()=>{
            let i = {k:'v'}
            const v = new ValidVal(i)
            if (i!==v.v) { return false }
            if (i!==v._v) { return false }
            let o = v.v
            if (i!==o) { return false }
            i = {l:'w'}
            if (v._runOnBegin(i)!==undefined) { return false } // 何もしない
            if (v._runOnValidate(i)!==true) { return false }   // 必ず真を返す
            if (v._runOnSet(i)!==i) { return false }           // 入力値をそのまま返す
            if (v._runOnSetDefault(i)!==o) { return false }    // 前回値をそのまま返す
            if (v._runOnValid(i,o)!==undefined) { return false }   // 何もしない
            if (v._runOnInvalid(i,o)!==undefined) { return false } // 何もしない
            if (v._runOnValid(i,o)!==undefined) { return false }   // 何もしない
            if (v._runOnChanged(i,o)!==undefined) { return false } // 何もしない
            if (v._runOnEnd(i,o)!==undefined) { return false }     // 何もしない
            return true
        },
        // onIfがないときは標準関数を使用する（代入値をそのまま返す）
        ()=>{
            let i = 0
            const v = new ValidVal(i)
            console.log(v.v)
            if (i!==v.v) { return false }
            i = 1
            v.v = i
            if (i!==v.v) { return false }
            i = 2
            v.v = i
            if (i!==v.v) { return false }
            return true
        },
        ()=>{
            const v = new ValidVal(0)
            if (0!==v.v) { return false }
            v.v++
            if (1!==v.v) { return false }
            v.v++
            if (2!==v.v) { return false }
            return true
        },
        ()=>{
            const v = new ValidVal(100)
            if (100!==v.v) { return false }
            v.v -= 50
            if (50!==v.v) { return false }
            v.v *= 3
            if (150!==v.v) { return false }
            return true
        },
        ()=>{
            const v = new ValidVal(0)
            if (0!==v.v) { return false }
            v.v = 'A'
            if ('A'!==v.v) { return false }
            v.v = null
            if (null!==v.v) { return false }
            return true
        },
        // onSet
        ()=>{
            const onSet = (i,o)=>i+100
            const v = new ValidVal(0, {onSet:onSet}) // 100加算した値を代入する
            console.log(v._onSet)
            if (v._onSet!==onSet) { return false }
            v.v++
            console.log(v.v)
            if (101!==v.v) { return false }
            return true
        },
        // onSet, onSetDefault：onValidateは初期値で常に真を返すからonSetしか実行されない
        ()=>{
            const onSet = (i,o)=>i+100    // 100加算した値を代入する
            const onSetDefault = (i,o)=>0 // 0を代入する
            const v = new ValidVal(-1, {onSet:onSet, onSetDefault:onSetDefault})
            if (v._onSet!==onSet) { return false }
            if (v._onSetDefault!==onSetDefault) { return false }
            v.v++
            if (100!==v.v) { return false }
            return true
        },
        // onValidateは初期値で常に真を返すからonSetしか実行されない
        ()=>{
            const onValidate = (i,o)=>0===i%2    // 入力値が偶数の時のみ代入する
            const v = new ValidVal(1, {onValidate:onValidate})
            if (v._onValidate!==onValidate) { return false }
            if (1!==v.v) { return false } // 奇数だが初期値の場合は代入される
            v.v = 3
            if (1!==v.v) { return false } // 入力値は奇数なのでInvalidとなりSetDefaultが実行される。その初期値は前回値をそのまま返すため初期値の1である
            v.v = 4
            if (4!==v.v) { return false } // 入力値は偶数なのでValidとなりSetが実行される。その初期値は入力値をそのまま返すため4である
            return true
        },
        ()=>{ // onValidate, onSet
            const onValidate = (i,o)=>0===i%2    // 入力値が偶数の時のみ代入する
            const onSet = (i,o)=>i+100    // 100加算した値を代入する
            const v = new ValidVal(1, {onValidate:onValidate, onSet:onSet})
            if (v._onValidate!==onValidate) { return false }
            if (v._onSet!==onSet) { return false }
            if (1!==v.v) { return false } // 奇数だが初期値の場合は代入される
            v.v = 3
            if (1!==v.v) { return false } // 入力値は奇数なのでInvalidとなりSetDefaultが実行される。その初期値は前回値をそのまま返すため初期値の1である
            v.v = 4
            if (104!==v.v) { return false } // 入力値は偶数なのでValidとなりSetが実行される。今回は入力値+100の値を返す
            return true
        },
        ()=>{ // onValidate, onSet, onSetDefault：妥当性確認の結果次第で代入処理を分岐する
            const onValidate = (i,o)=>0===i%2    // 入力値が偶数の時のみ代入する
            const onSet = (i,o)=>i+100    // Valid時、100加算した値を代入する
            const onSetDefault = (i,o)=>0 // Invalid時、0を代入する（初期値、前回値、条件内値などをセットする）
            const v = new ValidVal(1, {onValidate:onValidate, onSet:onSet, onSetDefault:onSetDefault})
            if (v._onValidate!==onValidate) { return false }
            if (v._onSet!==onSet) { return false }
            if (v._onSetDefault!==onSetDefault) { return false }
            if (1!==v.v) { return false } // 奇数だが初期値の場合は代入される
            v.v = 3
            if (0!==v.v) { return false } // 入力値は奇数なのでInvalidとなりSetDefaultが実行される。今回設定したそれは必ず0を返す
            v.v = 4
            if (104!==v.v) { return false } // 入力値は偶数なのでValidとなりSetが実行される。今回設定したそれは入力値+100の値を返す
            return true
        },
        ()=>{ // onValidate, onSet, onSetDefault, onValid, onInvalid：代入直後にValid/Invalid各場合のみ実行する。
            let validCnt = 0
            let invalidCnt = 0
            const onValidate = (i,o)=>0===i%2    // 入力値が偶数の時のみ代入する
            const onSet = (i,o)=>i+100    // Valid時、100加算した値を代入する
            const onSetDefault = (i,o)=>0 // Invalid時、0を代入する（初期値、前回値、条件内値などをセットする）
            const onValid = (n,i,o)=>validCnt++
            const onInvalid = (n,i,o)=>invalidCnt++
            const v = new ValidVal(1, {onValidate:onValidate, onSet:onSet, onSetDefault:onSetDefault, onValid:onValid, onInvalid:onInvalid})
            if (v._onValidate!==onValidate) { return false }
            if (v._onSet!==onSet) { return false }
            if (v._onSetDefault!==onSetDefault) { return false }
            if (v._onValid!==onValid) { return false }
            if (v._onInvalid!==onInvalid) { return false }
            if (1!==v.v) { return false } // 奇数だが初期値の場合は代入される
            if (0!==validCnt) { return false }
            if (0!==invalidCnt) { return false }
            v.v = 3
            if (0!==v.v) { return false } // 入力値は奇数なのでInvalidとなりSetDefaultが実行される。今回設定したそれは必ず0を返す
            if (0!==validCnt) { return false }
            if (1!==invalidCnt) { return false }
            v.v = 4
            if (104!==v.v) { return false } // 入力値は偶数なのでValidとなりSetが実行される。今回設定したそれは入力値+100の値を返す
            if (1!==validCnt) { return false }
            if (1!==invalidCnt) { return false }
            v.v = 6
            if (106!==v.v) { return false } // 入力値は偶数なのでValidとなりSetが実行される。今回設定したそれは入力値+100の値を返す
            if (2!==validCnt) { return false }
            if (1!==invalidCnt) { return false }
            return true
        },
        ()=>{ // onValidate, onSet, onSetDefault, onChanged：Valid/Invalidどちらでも前回値から変化したらonChangedを実行する
            let changedCnt = 0
            const onValidate = (i,o)=>0===i%2    // 入力値が偶数の時のみ代入する
            const onSet = (i,o)=>i+100    // Valid時、100加算した値を代入する
            const onSetDefault = (i,o)=>0 // Invalid時、0を代入する（初期値、前回値、条件内値などをセットする）
            const onChanged= (n,i,o)=>changedCnt++
            const v = new ValidVal(1, {onValidate:onValidate, onSet:onSet, onSetDefault:onSetDefault, onChanged:onChanged})
            if (v._onValidate!==onValidate) { return false }
            if (v._onSet!==onSet) { return false }
            if (v._onSetDefault!==onSetDefault) { return false }
            if (v._onChanged!==onChanged) { return false }
            if (1!==v.v) { return false } // 奇数だが初期値の場合は代入される
            if (0!==changedCnt) { return false }
            v.v = 3
            if (0!==v.v) { return false } // 入力値は奇数なのでInvalidとなりSetDefaultが実行される。今回設定したそれは必ず0を返す
            if (1!==changedCnt) { return false } // 初期値1から0に変化したのでonChanged実行する
            v.v = 3
            if (0!==v.v) { return false } // 入力値は奇数なのでInvalidとなりSetDefaultが実行される。今回設定したそれは必ず0を返す
            if (1!==changedCnt) { return false } // 初期値0から同値0で変化しなかったのでonChanged実行せず
            v.v = 4
            if (104!==v.v) { return false } // 入力値は偶数なのでValidとなりSetが実行される。今回設定したそれは入力値+100の値を返す
            if (2!==changedCnt) { return false } // 初期値0から104に変化したのでonChanged実行する
            return true
        },

        ()=>{ // 全部乗せ：onBegin, onValidate, onSet, onSetDefault, onValid, onInvalid, onEnd
            const count = {
                Begin: 0,
                Validate: 0,
                Set: 0,
                SetDefault: 0,
                Valid: 0,
                Invalid: 0,
                Changed: 0,
                End: 0,
            }
            const on = {
                Begin: (i,o)=>count.Begin++,
                Validate: (i,o)=>0===i%2,           // 入力値が偶数の時のみ代入する
                Set: (i,o)=>i+100,                  // Valid時、100加算した値を代入する
                SetDefault: (i,o)=>0,               // Invalid時、0を代入する（初期値、前回値、条件内値などをセットする）
                Valid: (n,i,o)=>count.Valid++,
                Invalid: (n,i,o)=>count.Invalid++,
                Changed: (n,i,o)=>count.Changed++,
                End: (n,i,o)=>count.End++,
            }
            const v = new ValidVal(1, {
                onBegin: on.Begin,
                onValidate: on.Validate,
                onSet: on.Set,
                onSetDefault: on.SetDefault, 
                onValid: on.Valid,
                onInvalid: on.Invalid,
                onChanged: on.Changed,
                onEnd: on.End,
            })
            if (v._onBegin!==on.Begin) { return false }
            if (v._onValidate!==on.Validate) { return false }
            if (v._onSet!==on.Set) { return false }
            if (v._onSetDefault!==on.SetDefault) { return false }
            if (v._onValid!==on.Valid) { return false }
            if (v._onInvalid!==on.Invalid) { return false }
            if (v._onChanged!==on.Changed) { return false }
            if (v._onEnd!==on.End) { return false }

            if (1!==v.v) { return false } // 奇数だが初期値の場合は代入される
            if (0!==count.Begin) { return false }
            if (0!==count.Valid) { return false }
            if (0!==count.Invalid) { return false }
            if (0!==count.Changed) { return false }
            if (0!==count.End) { return false }

            v.v = 3
            if (0!==v.v) { return false } // 入力値は奇数なのでInvalidとなりSetDefaultが実行される。今回設定したそれは必ず0を返す
            if (1!==count.Begin) { return false }
            if (0!==count.Valid) { return false }
            if (1!==count.Invalid) { return false }
            if (1!==count.Changed) { return false } // 初期値1から0に変化したのでonChangedを実行する
            if (1!==count.End) { return false }

            v.v = 4
            if (104!==v.v) { return false } // 入力値は偶数なのでValidとなりSetが実行される。今回設定したそれは入力値+100の値を返す
            if (2!==count.Begin) { return false }
            if (1!==count.Valid) { return false }
            if (1!==count.Invalid) { return false }
            if (2!==count.Changed) { return false } // 0から104に変化したのでonChangedを実行する
            if (2!==count.End) { return false }

            v.v = 6
            if (106!==v.v) { return false } // 入力値は偶数なのでValidとなりSetが実行される。今回設定したそれは入力値+100の値を返す
            if (3!==count.Begin) { return false }
            if (2!==count.Valid) { return false }
            if (1!==count.Invalid) { return false }
            if (3!==count.Changed) { return false } // 104から106に変化したのでonChangedを実行する
            if (3!==count.End) { return false }

            v.v = 0
            console.log(v.v)
            if (100!==v.v) { return false } // 入力値は偶数なのでValidとなりSetが実行される。今回設定したそれは入力値+100の値を返す
            if (4!==count.Begin) { return false }
            if (3!==count.Valid) { return false }
            if (1!==count.Invalid) { return false }
            if (4!==count.Changed) { return false } // 106から100に変化したのでonChangedを実行する
            if (4!==count.End) { return false }

            v.v = 0
            if (100!==v.v) { return false } // 入力値は偶数なのでValidとなりSetが実行される。今回設定したそれは入力値+100の値を返す
            if (5!==count.Begin) { return false }
            if (4!==count.Valid) { return false }
            if (1!==count.Invalid) { return false }
            if (4!==count.Changed) { return false } // 0から0で変化なくonChangedを実行せず
            if (5!==count.End) { return false }
            return true
        },
//        ()=>Test.assertError(Error, '入力strは次のいずれかのケースであるべきです。chain,snake,camel,pascal,constant,title', ()=>complexCase.toChain()),
    ])
})
</script>

<h1></h1>
<header></header>
<main></main>
<footer></footer>

